{
  "name": "Apricot-analysis",
  "items": [
    {
      "name": "Anomalous HTTP Response Codes (>=400)",
      "value": "_path==\"http\" AND status_code >= 400 | count() by status_code | sort -r",
      "description": "Shows the count of HTTP response codes that indicate errors (400 and above)"
    },
    {
      "name": "HTTP Traffic by Content Type (MIME)",
      "value": "_path==\"http\" | count() by mime_type | sort -r",
      "description": "Displays HTTP traffic distribution by MIME content types"
    },
    {
      "name": "HTTP Responses with Large Payloads (>10MB)",
      "value": "_path==\"http\" | put resp_size_bytes := if(resp_size != null(), resp_size, 0) | filter resp_size_bytes > 10485760 | count() by uri | sort -r",
      "description": "Detects HTTP responses with large payloads"
    },
    {
      "name": "HTTP to Known Suspicious IPs",
      "value": "_path==\"http\" AND id.resp_h in (\"malicious_ip1\", \"malicious_ip2\", \"malicious_ip3\") | count() by id.resp_h | sort -r",
      "description": "Detects outbound HTTP traffic to known malicious IP addresses (replace placeholders with real IPs or feed)"
    },
    {
      "name": "HTTP Redirect Response Codes (3xx)",
      "value": "_path==\"http\" AND status_code >= 300 AND status_code < 400 | count() by status_code | sort -r",
      "description": "Detects HTTP responses with status codes indicating redirects"
    },
    {
      "name": "Unusual Protocols Summary",
      "value": "_path==\"conn\" | count() by proto | sort -r | filter proto not in (\"tcp\", \"udp\", \"icmp\")",
      "description": "Identifies unusual protocols in network traffic"
    },
    {
      "name": "Short-Lived Connections (<60s)",
      "value": "_path==\"conn\" | filter duration != null() AND duration < 60 | count() by id.orig_h, id.resp_h | sort -r",
      "description": "Detects short-lived network connections (less than 1 minute)"
    },
    {
      "name": "Long-Lived Connections (>1h)",
      "value": "_path==\"conn\" | filter duration != null() AND duration > 3600 | count() by id.orig_h, id.resp_h | sort -r",
      "description": "Detects long-lived network connections (more than 1 hour)"
    },
    {
      "name": "Top SMTP Senders (by source IP)",
      "value": "_path==\"smtp\" | count() by id.orig_h | sort -r",
      "description": "Shows the IP addresses sending the most SMTP traffic"
    },
     {
      "name": "Top Talkers by Bytes Transferred",
      "value": "_path==\"conn\" | put total_bytes := orig_bytes + resp_bytes | count() by id.orig_h | sort -r total_bytes",
      "description": "Highlights hosts that transmit or receive the most data in the network"
    },
    {
      "name": "Long-Lived HTTP Connections",
      "value": "_path==\"http\" | put duration := ts - orig_ts | filter duration > 3600 | count() by id.orig_h, id.resp_h | sort -r",
      "description": "Detects persistent HTTP connections lasting more than 1 hour, possibly indicating data exfiltration"
    },
    {
      "name": "High-Frequency DNS Queries",
      "value": "_path==\"dns\" | count() by query | filter count > 100 | sort -r",
      "description": "Detects domains with unusually high request rates, possibly indicating automated activity"
    },
    {
      "name": "SMTP Traffic by Sender (mailfrom)",
      "value": "_path==\"smtp\" | count() by mailfrom | sort -r",
      "description": "Shows SMTP traffic distribution by sender address"
    },
    {
      "name": "Outbound SMTP to Unusual Domains (suggest whitelist config)",
      "value": "_path==\"smtp\" AND mailfrom != \"\" | put domain := re_replace(mailfrom, \".*@(.+)$\", \"$1\") | filter domain != null() AND NOT (domain in (\"gmail.com\", \"yahoo.com\", \"hotmail.com\")) | count() by domain | sort -r",
      "description": "Identifies outbound SMTP senders using domains that are not common personal providers"
    },
    {
      "name": "Large Outbound Email Attachments (>10MB)",
      "value": "_path==\"smtp\" | put attach_size := if(attachment_size != null(), attachment_size, 0) | filter attach_size > 10485760 | count() by id.orig_h | sort -r",
      "description": "Identifies SMTP messages with large outbound attachments (field names may vary)"
    },
    {
      "name": "SMTP Commands Overview",
      "value": "_path==\"smtp\" | count() by command | sort -r",
      "description": "Analyzes SMTP commands to understand email traffic patterns"
    },
    {
      "name": "SMTP by Sender Domain (parsed)",
      "value": "_path==\"smtp\" AND mailfrom != \"\" | put domain := re_replace(mailfrom, \".*@(.+)$\", \"$1\") | count() by domain | sort -r",
      "description": "Analyzes SMTP traffic by sender domain"
    },
    {
      "name": "SMB/CIFS Activity (files & mapping)",
      "value": "_path in (\"smb_files\", \"smb_mapping\") | count() by command | sort -r",
      "description": "Analyzes SMB/CIFS traffic patterns to identify common file-sharing commands"
    },
    {
      "name": "Potential DDoS Targets (high connection count)",
      "value": "_path==\"conn\" | count() by id.resp_h | sort -r | filter count > 1000",
      "description": "Identifies potential DDoS targets by looking for IPs with very high connection counts"
    },
    {
      "name": "Unauthorized SSH Access Attempts (failed auth)",
      "value": "_path==\"ssh\" AND auth_success==false | count() by id.orig_h | sort -r",
      "description": "Displays failed SSH access attempts to identify potential brute force activity"
    },
    {
      "name": "Suspicious HTTP User-Agents (automation tools)",
      "value": "_path==\"http\" | filter user_agent =~ /(curl|wget|python|java|libwww|httpclient)/i | count() by user_agent | sort -r",
      "description": "Identifies User-Agents commonly used by automated tools"
    },
    {
      "name": "Uncommon User-Agent Strings",
      "value": "_path==\"http\" | filter user_agent != null() | filter not user_agent in (\"Mozilla\", \"Chrome\", \"Firefox\", \"Safari\", \"Edge\") | count() by user_agent | sort -r",
      "description": "Identifies uncommon or suspicious User-Agent strings in HTTP requests"
    },
    {
      "name": "DNS Tunneling Candidates (long queries)",
      "value": "_path==\"dns\" | put qlen := if(length(query) != null(), length(query), 0) | filter qlen > 50 | count() by query | sort -r",
      "description": "Detects unusually long DNS queries that might be DNS tunneling"
    },
    {
      "name": "DNS NXDOMAIN with Long Queries",
      "value": "_path==\"dns\" AND rcode==\"NXDOMAIN\" | put qlen := if(length(query) != null(), length(query), 0) | filter qlen > 50 | count() by query | sort -r",
      "description": "Identifies NXDOMAIN responses for long queries (possible tunneling)"
    },
    {
      "name": "Rare DNS Queries (observed < 5 times)",
      "value": "_path==\"dns\" | count() by query | filter count < 5 | sort -r",
      "description": "Lists DNS queries observed less than 5 times"
    },
    {
      "name": "Potential DNS Amplification (ANY qtype & large rlength)",
      "value": "_path==\"dns\" AND qtype==\"ANY\" AND rcode==\"NOERROR\" AND rlength > 512 | count() by id.orig_h | sort -r",
      "description": "Detects large responses to ANY queries that may be used for amplification"
    },
    {
      "name": "Large DNS Responses",
      "value": "_path==\"dns\" AND rlength > 512 | count() by query | sort -r",
      "description": "Detects DNS responses larger than 512 bytes"
    },
    {
      "name": "Outbound DNS to Suspicious TLDs",
      "value": "_path==\"dns\" | put tld := re_replace(query, \".*\\.([^.]+)$\", \".$1\") | filter tld in (\".tk\", \".xyz\", \".pw\", \".top\") | count() by query | sort -r",
      "description": "Detects outbound DNS queries that end with suspicious TLDs"
    },
    {
      "name": "Insecure Protocol Usage",
      "value": "_path==\"conn\" AND proto in (\"ftp\", \"telnet\", \"http\") | count() by proto | sort -r",
      "description": "Identifies use of unencrypted/insecure protocols"
    },
    {
      "name": "High-Risk IPs from Intel (if available)",
      "value": "_path==\"intel\" | count() by seen.addr | sort -r",
      "description": "Lists IP addresses flagged by integrated threat intelligence (field availability depends on pipeline)"
    },
    {
      "name": "Connections to Known Malicious IPs (intel hit)",
      "value": "_path==\"conn\" AND intel.hit==true | cut id.orig_h, id.resp_h, service, proto | count() by id.resp_h | sort -r",
      "description": "Shows connections flagged by threat intelligence"
    },
    {
      "name": "Top Network Services",
      "value": "_path==\"conn\" | count() by service | sort -r",
      "description": "Displays the most frequently observed services"
    },
    {
      "name": "Unusual DNS Query Patterns (low-occurrence)",
      "value": "_path==\"dns\" | count() by query | filter count < 5 | sort -r",
      "description": "Identifies DNS queries with low frequency"
    },
    {
      "name": "SSH Brute Force Attempts (>=3 auth failures)",
      "value": "_path==\"ssh\" AND auth_attempts >= 3 | count() by id.orig_h | sort -r",
      "description": "Detects likely SSH brute-force activity"
    },
    {
      "name": "SSH Traffic by Command",
      "value": "_path==\"ssh\" | count() by command | sort -r",
      "description": "Overview of SSH commands if recorded"
    },
    {
      "name": "Outbound SSH to Non-Standard Ports",
      "value": "_path==\"ssh\" AND id.resp_p not in (22, 2222) | count() by id.resp_p | sort -r",
      "description": "Detects SSH connections to non-standard ports"
    },
    {
      "name": "TLS Certificate Expiry Analysis",
      "value": "_path==\"tls\" | cut id.resp_h, subject, issuer, valid_from, valid_until | sort valid_until",
      "description": "Analyzes TLS certificate validity periods"
    },
    {
      "name": "TLS Handshake Patterns (version/cipher)",
      "value": "_path==\"tls\" | count() by version, cipher | sort -r",
      "description": "Counts combinations of TLS versions and ciphers"
    },
    {
      "name": "Self-signed Certificates",
      "value": "_path==\"tls\" AND certificate_chain_fuids == \"-\" | count() by id.orig_h | sort -r",
      "description": "Detects TLS handshakes where the certificate chain indicates a possible self-signed cert"
    },
    {
      "name": "FTP Activity Overview",
      "value": "_path==\"ftp\" | count() by command | sort -r",
      "description": "Analyzes FTP activity"
    },
    {
      "name": "FTP Uploads with Suspicious Extensions",
      "value": "_path==\"ftp\" AND command==\"put\" | filter arg != null() | filter not arg =~ /\\.(txt|pdf|doc|xls)$/i | count() by arg | sort -r",
      "description": "Identifies FTP uploads with potentially suspicious file extensions"
    },
    {
      "name": "FTP Invalid Login Attempts",
      "value": "_path==\"ftp\" AND reply_code==530 | count() by user | sort -r",
      "description": "Detects failed FTP login attempts"
    },
    {
      "name": "IRC Activity Summary",
      "value": "_path==\"irc\" | count() by command | sort -r",
      "description": "Overview of IRC commands"
    },
    {
      "name": "SIP/VoIP Methods",
      "value": "_path==\"sip\" | count() by method | sort -r",
      "description": "Summarizes SIP methods observed"
    },
    {
      "name": "ICMP Echo Requests (Ping)",
      "value": "_path==\"icmp\" AND icmp_type==8 | count() by id.orig_h | sort -r",
      "description": "Identifies hosts generating ICMP echo requests"
    },
    {
      "name": "Large ICMP Echo (>1KB)",
      "value": "_path==\"icmp\" AND icmp_type==8 AND size > 1024 | count() by id.orig_h | sort -r",
      "description": "Detects large ICMP echo payloads"
    },
    {
      "name": "Unencrypted Traffic (exclude TLS)",
      "value": "_path==\"conn\" AND NOT (service==\"ssl\" OR service==\"tls\") | count() by proto | sort -r",
      "description": "Detects unencrypted traffic"
    },
    {
      "name": "SQL Injection Indicators in HTTP URIs",
      "value": "_path==\"http\" | filter uri =~ /(select|union|insert|update|delete|exec|xss|injection)/i | count() by id.orig_h | sort -r",
      "description": "Detects HTTP URIs that contain common SQL injection or XSS keywords"
    },
    {
      "name": "Outbound UDP to Non-Standard Ports",
      "value": "_path==\"conn\" AND proto==\"udp\" AND id.orig_p not in (53, 123, 161) | count() by id.orig_p | sort -r",
      "description": "Detects UDP traffic to less-common source ports"
    },
    {
      "name": "High-Entropy Destination Hostnames",
      "value": "_path==\"conn\" | put h := id.resp_h | filter h != null() AND entropy(h) > 4 | count() by id.orig_h | sort -r",
      "description": "Detects traffic to high-entropy hostnames (DGA candidates) â€” entropy() availability depends on pipeline"
    },
    {
      "name": "Long Hostnames in HTTP Requests",
      "value": "_path==\"http\" | put hostlen := if(host != null(), length(host), 0) | filter hostlen > 30 | count() by id.orig_h | sort -r",
      "description": "Detects HTTP traffic to hosts with long domain names (possible DGA/obfuscation)"
    }
  ]
}
